var dbAccess = require('dbAccess');
var listIssues = require('listIssues');
var tags = require('tags');
var url = require('url');

var g_UserId = -1;

var SearchTagIssue = exports.SearchTagIssue = function() {
};

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
SearchTagIssue.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);

	request.getUser(function(error, user) {
		if (error) throw error;

		if (user) g_UserId = user.id;
		tags.getIssuesByTag(parsedURL.query.tag, function(issueIds) {
			if (issueIds.length != 0) {
				var sqlQuery = 'SELECT * FROM issues WHERE ';
				for (i = 0; i < issueIds.length - 1; i++) {
					sqlQuery += 'id = ' + issueIds[i] + ' OR ';
				}
				sqlQuery += 'id = ' + issueIds[i];
				dbAccess.runQuery(sqlQuery, listIssues.getPageCount(1, 'lastModified', response, user, sqlQuery));
			} else {
				response.render('views/searchTagIssue.html', {tag : parsedURL.query.tag});
			}
		});
	});
};
