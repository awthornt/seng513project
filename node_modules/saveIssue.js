var dbAccess = require('dbAccess.js'),
	url = require('url'),
	tags = require('tags'),
	formidable = require('formidable'),
	sanitizeInputs = require('sanitizeInputs.js');

var SaveIssue = exports.SaveIssue = function() {
};

/**
 * Send the HTML page to the client(redirection to the detail view).
 * @param response Response object to send the data
 * @param id Issue id to redirect
 */
function serve(response,id) {
	return function(error, rows) {
		if (error) {
			console.log("Error Adding Issue");
			throw error;
		}
		console.log("Issue saved.");
		
		response.writeHeader(200, {'Content-Type': 'text/html'});
		response.end('Redirecting....... <script language="JavaScript"> self.location="viewIssue?id='+id+'"; </script>');
    };
}

/**
 * Update the DB with the new information
 * @param response Response object to send the data
 * @param POST post data
 */
function updateDB(POST, response) {
	var sqlQuery = 'UPDATE issues SET title="' + sanitizeInputs.removeTags(POST.title) +
					'",description="' + sanitizeInputs.removeTags(POST.description) +
					'",location="' + sanitizeInputs.removeTags(POST.location) +
					'",link="' + sanitizeInputs.removeTags(POST.link) +
					'", status="' + sanitizeInputs.removeTags(POST.status);
	if (typeof POST.fileLocation == 'string')
	 	sqlQuery += '", fileLocation="' + POST.fileLocation;
	sqlQuery += '" WHERE id=' + POST.id;
	
	dbAccess.runQuery(sqlQuery, function(error) {
		if (error) {
			util.log('Error updating issue. Came from saveIssue.updateDB.');
		}
		tags.updateTags(POST.id, POST.tags, serve(response, POST.id));
	});
}

/**
 * Receive the POST data and pass it to the updateDB funtion
 * @param response Response object to send the data
 * @param request Incoming request
 */   
function getPost(request, response) {
	// request.setEncoding("utf8");
	// request.content = '';
	// request.addListener("data", function(chunk) {
	// 	request.content += chunk;
	// });
	//  
	// request.addListener("end", function() {
	// 	var qs = require('querystring');
	// 	POST=qs.parse(request.content);
	// 	updateDB(POST,response);
	// });
	var form = formidable.IncomingForm();
	//TODO: I think this can break too easily.
	//would like to have __approot + '/public/uploads/'
	form.uploadDir = __dirname + '/../public/uploads/';
	
	form.parse(request, function(err, fields, files){
//		if (err) throw err;
		
		console.log(fields);
		console.log(files);
		
		if(files.file){
			var newPath = form.uploadDir + fields.id + "/"
			fs.mkdir(newPath, 755);
			var newName = newPath + files.file.name;
			fs.rename(files.file.path, newName);
			fields.fileLocation = files.file.name;
		}
		
		if(fields.deleteFile) fields.fileLocation = '';
		
		updateDB(fields, response);
	});
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
SaveIssue.display = function(request, response) {
   getPost(request,response);
}
