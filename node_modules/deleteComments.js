var dbAccess = require('dbAccess');
var url = require('url');
var querystring = require('querystring');
var url = require('url');
var user = require('user');

var DeleteComments = exports.DeleteComments = function() {
};

DeleteComments.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);
	var commentId = parsedURL.query.cid;
	var issueId = parsedURL.query.iid;
	
	var sqlQuery = "SELECT content FROM comments WHERE id=" + commentId;
	
	dbAccess.runQuery(sqlQuery, function(error, rows)
    {
		if(error) throw error;
		
		var variables = {
			iTitile : 'Are you sure to delete this Comment?',
			iContent : rows[0].content,
			iIssueId : issueId,
			iCommentId: commentId
		}
		response.render('views/deleteComments.html',variables);
	});
}
DeleteComments.confirmed = function(request, response) {
	user.getUserFromRequest(request, function(error, user) {
		var parsedURL = url.parse(request.url, true);
		var commentId = parsedURL.query.cid;
		var issueId = parsedURL.query.iid;
		
		if(error) throw error;
		if(user == null) {
			response.statusCode = 302;
			response.setHeader('Location', "/viewIssue?id="+issueId);
			response.end();
		}
		else {
			dbAccess.find("comments", {conditions:['id='+commentId, 'issue_id=' + issueId, 'user_id='+user.id]}, function(error, rows) {
				if(error) throw error;
				if(rows.length == 0) {
					response.statusCode = 302;
					response.setHeader('Location', "/viewIssue?id="+issueId);
					response.end();
				}
				else {
					var sqlQuery = "DELETE FROM comments WHERE id=" + commentId;
		
					dbAccess.runQuery(sqlQuery, function(error, rows) {
						if(error) throw error;
						response.statusCode = 302;
						response.setHeader('Location', "/viewIssue?id="+issueId);
						response.end();
					});
				}
			});
		}
	});
	

}
