var user = require('user'),
dbAccess = require('./dbAccess'),
queryString = require('querystring');
referral = require('referral');

var view = 'views/signIn.html';

redirectTo = function (res, route) {
	res.statusCode = 302;
	res.setHeader('Location', route);
	res.end();
}

exports.signin = function(req, res) {
	var variables = {};

	if(req.method != 'POST'){
		variables.inputlimit = 150;
		res.render(view, variables);
		return;
	}
		
	req.content = '';
	
	req.on('data', function(chunk) {
		req.content += chunk;
	})
	
	req.on('end', function(){
		req.params = queryString.parse(req.content);
		
		var params = req.params; 
		//This is the cookie session expiration date
		var date = new Date();
		date.setDate(date.getDate() + 7);
		
		user.authenticate(params.email, params.password, function (error, user) {
			
			if (error)
				throw error;
			
			if (user) {
				// For now this generates a unique session and then assigns it to 
				// the user cookie and inserts it in the sessions table.
				var sessionString = generateHash(user.id);
				var query = "INSERT INTO sessions (user_id, session_hash) VALUES ('" + user.id + "','" + sessionString + "');";
	
				dbAccess.runQuery(query, function(error){
					res.setHeader('Set-Cookie', 'session=' + sessionString + '; Expires=' + date);
					redirectTo(res, referral.site());
					referral.history(0);
				});
				/* Note: there is a code duplicate of session generation in the signup module.  
				 * Changes to this section should be reflected there, or a new issue created. */
				
			} else {
				res.render(view, {error: 'Sign In Failed. Please try again.'});
			}
		}); 
	})
}

function generateHash(id) {
	var timestamp = new Date().getTime();
	var toHash = (timestamp+id).toString();
	return user.md5hash(toHash);
}

exports.signout = function(req, res){
	res.setHeader('Set-Cookie', 'session=' + 0 + ';Expires=Thu, 01-Jan-1970 00:00:01 GMT');
	redirectTo(res, '/');
}
