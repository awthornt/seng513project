var util = require('util'),
	dbAccess = require('dbAccess'),
	nodemailer = require('Nodemailer/lib/mail'),
	settings = require('settings'),
	emailAccount = settings.getSetting('email_account'),
	emailPassword = settings.getSetting('email_password'),
	smtpServer = settings.getSetting('email_smtp_server');

nodemailer.SMTP = {
	host: smtpServer,
	port: 465,
	use_authentication: true,
	ssl: true,
	user: emailAccount,
	pass: emailPassword
}

exports.sendPlainTextEmailToUserId = function(userId, subject, body, callback) {
	// Run a query to get the email address of the user
	var dbAccess = require('dbAccess');
	var q = "SELECT email FROM users WHERE id=" + userId;
	dbAccess.runQuery(q, function(error, results) {
		// Handle any issues
		if (error) {
			callback(error);
		}
		else if (results.length != 1) {
			callback("Error: no results for userId " + userId);
		}
		// If no errors, send the email
		else {
			var message = {
				sender: 'Civic Connect <' + emailAccount + '>',
				to: results[0].email,
				subject: subject,
				body: body
			}
			
			nodemailer.send_mail(message, callback);
		}
	});
}

exports.sendHTMLEmailToUserId = function(userId, subject, body, callback) {
	// Run a query to get the email address of the user
	var dbAccess = require('dbAccess');
	var q = "SELECT email FROM users WHERE id=" + userId;
	dbAccess.runQuery(q, function(error, results) {
		// Handle any issues
		if (error) {
			callback(error);
		}
		else if (results.length != 1) {
			callback("Error: no results for userId " + userId);
		}
		// If no errors, send the email
		else {
			var message = {
				sender: 'Civic Connect <' + emailAccount + '>',
				to: results[0].email,
				subject: subject,
				// We can leave out the body, since most email clients will convert
				// to plain text if they don't support HTML emails
				html: body
			}
			
			nodemailer.send_mail(message, callback);
		}
	});
}

exports.sendPlainTextEmailToAddress = function(toEmailAddress, subject, body, callback) {
	var message = {
		sender: 'Civic Connect <' + emailAccount + '>',
		to: toEmailAddress,
		subject: subject,
		body: body
	}

	nodemailer.send_mail(message, callback);
}

exports.sendHTMLEmailToAddress = function(toEmailAddress, subject, body, callback) {
	var message = {
		sender: 'Civic Connect <' + emailAccount + '>',
		to: toEmailAddress,
		subject: subject,
		// We can leave out the body, since most email clients will convert
		// to plain text if they don't support HTML emails
		html: body
	}
	
	nodemailer.send_mail(message, callback);
}
