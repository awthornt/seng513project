var dbAccess = require('dbAccess');
var url = require('url');
var querystring = require('querystring');
var url = require('url');
var sanitizeInputs = require('sanitizeInputs.js');

var EditComments = exports.EditComments = function() {
};

EditComments.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);
	var commentId = parsedURL.query.cid;
	var issueId = parsedURL.query.iid;
	var sqlQuery = "SELECT content FROM comments WHERE id=" + commentId;

	dbAccess.runQuery(sqlQuery, function(error, rows)
	{
    if(error) throw error;
    var variables = {
		 iTitile : 'Edit Your Comment',
		 iContent : rows[0].content,
		 iIssueId : issueId,
		 iCommentId: commentId,
		 inputlimit: 150,
		 textarealimit: 5000
	}
    response.render('views/editComments.html',variables);
	});
}

EditComments.save = function(request, response) {
   var parsedURL = url.parse(request.url, true);
   var commentId = parsedURL.query.cid;
   var issueId = parsedURL.query.iid;
   var requestString = "";
   request.on('data', function (chunk) {
		requestString = requestString+chunk;
   });

	request.on('end', function()
    {
		var decodedBody = querystring.parse(requestString);
		var newContent = decodedBody.comments;
		var sqlQuery = "UPDATE comments SET content =" + "'" + sanitizeInputs.removeTags(newContent) + "'" + " WHERE id=" + commentId;
		dbAccess.runQuery(sqlQuery, function(error, rows){
			if(error) throw error;
			response.statusCode = 302;
			response.setHeader('Location', "/viewIssue?id="+issueId);
			response.end();
		});

	});
}